<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
    前端仓库迁移整改汇总 - blogs
    
    </title>
    

    
    
    <link href="atom.xml" rel="alternate" title="blogs" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/style.min.css">
    <link rel="stylesheet" href="asset/css/doc.css">
    <script src="asset/app.js"></script>
</head>
  <body>
    <section class="hero">
      <div class="hero-head">
          <nav class="navbar" role="navigation" aria-label="main navigation">
              <div class="container">
              <div class="navbar-brand">
                
                <a target="_self" class="navbar-item " href="index.html">首页</a>
                
                <a target="_self" class="navbar-item " href="archives.html">文档</a>
                

                <a role="button" id="navbarSNSRssSwitchBtn" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbarSNSRssButtons">
                  <span aria-hidden="true"></span>
                  <span aria-hidden="true"></span>
                  <span aria-hidden="true"></span>
                </a>
              </div>
            
              <div id="navbarSNSRssButtons" class="navbar-menu">
                <div class="navbar-start">
                  
                </div>
            
                <div class="navbar-end">
                  <div class="navbar-item">
                    <!--buttons start-->
                    <div class="buttons">
                      
                        
                        
                        
                        
                      
                      <a href="atom.xml" target="_blank" title="RSS">
                          <span class="icon is-large has-text-black-bis">
                              <svg class="svg-inline--fa fa-rss fa-w-14 fa-lg" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg><!-- <i class="fas fa-rss fa-lg"></i> -->
                          </span>
                      </a>
                    </div>
                    <!--buttons end-->

                  </div>
                </div>
                </div>
              </div>
            </nav>
      </div>

 <div class="hero-body ct-body"></div>
      
    </section>
    <section class="ct-body">
      <div class="container">
          <div class="columns is-variable bd-klmn-columns is-4 is-centered">
              <div class="column is-four-fifths">
                  <div class="post-body single-content">
                    
                    <h1 class="title">
                            前端仓库迁移整改汇总   
                      </h1>
                     
                    
                      <div class="media">
                            
                            <div class="media-content">
                              <div class="content">
                                <p>
                                 <span class="date">2022/07/23</span>
                                  <span class="tran-posted-in">posted in</span>&nbsp; 
                                  
                                      <span class="posted-in"><a href='Others.html'>Others</a></span>
                                         
                                  

                                   
                                      
                                  <br />
                                  <span class="tran-tags">Tags:</span>&nbsp;
                                     

                                </p>
                              </div>
                            </div>
                         
                    </div>
                </div>
                  <article class="markdown-body single-content">
                    <ul>
<li><a href="#%E8%83%8C%E6%99%AF">背景</a></li>
<li><a href="#%E8%BF%81%E7%A7%BB%E4%BB%93%E5%BA%93%E5%9C%B0%E5%9D%80">迁移仓库地址</a></li>
<li><a href="#wizdom-react-submodule">Wizdom-react &amp; submodule</a>
<ul>
<li><a href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84">目录结构</a></li>
<li><a href="#git%E6%93%8D%E4%BD%9C">git操作</a>
<ul>
<li><a href="#1%E3%80%81%E6%96%B0%E5%A2%9Esubmodule">1、新增submodule</a></li>
<li><a href="#2%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96submodule">2、初始化submodule</a></li>
<li><a href="#3%E3%80%81%E6%9B%B4%E6%96%B0submodule">3、更新submodule</a></li>
<li><a href="#4%E3%80%81%E5%88%A0%E9%99%A4submodule">4、删除submodule</a></li>
</ul>
</li>
<li><a href="#%E9%A1%B9%E7%9B%AE%E5%90%AF%E5%8A%A8%E6%88%96%E6%89%93%E5%8C%85">项目启动或打包</a>
<ul>
<li><a href="#%E8%BF%90%E8%A1%8C%E5%8E%9Fpages%E4%B8%8B%E7%9A%84%E4%BB%A3%E7%A0%81">运行原 pages 下的代码</a></li>
<li><a href="#%E8%BF%90%E8%A1%8Cplugins%E4%B8%8B-submodule%E4%BB%A3%E7%A0%81">运行 plugins 下submodule代码</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E6%94%B6%E8%8E%B7%E4%B8%8E%E5%88%86%E4%BA%AB">收获与分享</a>
<ul>
<li><a href="#1%E3%80%81prettier%E6%89%B9%E9%87%8F%E6%A0%BC%E5%BC%8F%E5%8C%96">1、prettier 批量格式化</a></li>
<li><a href="#2%E3%80%81%E5%85%A8%E5%B1%80%E6%9B%BF%E6%8D%A2%E5%BC%95%E7%94%A8%E8%B7%AF%E5%BE%84">2、全局替换引用路径</a></li>
</ul>
</li>
</ul>
<h1><a id="%E8%83%8C%E6%99%AF" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>背景</h1>
<p>最近测试部门主导进行了一次仓库迁移整改，对于前端来说，期望达到的目标有2个：</p>
<p>1、可以直接通过脚本编译打包源码，从而前端研发不再需要提交打包后的文件到wizdom-urban-v14这个庞大无比的仓库；</p>
<p>2、前端代码也可以进行版本管理，包括hotfix、release等分支，解决由于后端变更较大导致的前后端版本不兼容的问题；</p>
<p>我们部门前端仓库非常多，其中有很大一部分是从原前端组转交过来的，初步计划7月底将所有仓库迁移到<a href="http://192.168.101.70:8000/csgl/frontend">csgl/frontend</a>这个分组下，后期找代码就会非常方便，只需要关注本部门的分组即可。</p>
<h1><a id="%E8%BF%81%E7%A7%BB%E4%BB%93%E5%BA%93%E5%9C%B0%E5%9D%80" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>迁移仓库地址</h1>
<p>持续更新中~~~</p>
<p><a href="https://alidocs.dingtalk.com/spreadsheetv2/pg9JjM8PrUNBaY2l/edit?dentryKey=pg9JjM8PrUNBaY2l&amp;dd_user_keyboard=false&amp;dd_progress=true&amp;dt_editor_toolbar=true&amp;sheet_range=s1_0_0_1_1">https://alidocs.dingtalk.com/spreadsheetv2/pg9JjM8PrUNBaY2l/edit?dentryKey=pg9JjM8PrUNBaY2l&amp;dd_user_keyboard=false&amp;dd_progress=true&amp;dt_editor_toolbar=true&amp;sheet_range=s1_0_0_1_1</a></p>
<p>注意：已经完成迁移的项目，会陆陆续续关闭提交权限，所以如果有新需求，请大家尽量往新仓库提交代码。</p>
<h1><a id="wizdom-react-submodule" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Wizdom-react &amp; submodule</h1>
<p>wizdom-react是一个基于React的前端框架，里边包含非常多的子系统代码。本部门主要包括以下11个：</p>
<table>
<thead>
<tr>
<th>项目</th>
<th>名称</th>
</tr>
</thead>
<tbody>
<tr>
<td>advertisement</td>
<td>户外广告</td>
</tr>
<tr>
<td>cityexam</td>
<td>北京城市体检</td>
</tr>
<tr>
<td>egovaszyd</td>
<td>青岛三重一大</td>
</tr>
<tr>
<td>egovatydc</td>
<td>通用督查</td>
</tr>
<tr>
<td>vote</td>
<td>龙岩电子投票</td>
</tr>
<tr>
<td>wizsite</td>
<td>天津滨海智慧工地</td>
</tr>
<tr>
<td>wizsitenew</td>
<td>天津滨海智慧工地(新)</td>
</tr>
<tr>
<td>extract</td>
<td>龙岩双随机</td>
</tr>
<tr>
<td>butler</td>
<td>红色管家</td>
</tr>
<tr>
<td>constraint</td>
<td>联合约束</td>
</tr>
<tr>
<td>starevaluation</td>
<td>龙岩星级评价</td>
</tr>
</tbody>
</table>
<p>之所以单独列出来，是因为它们与其它仓库的迁移有所不同，其它项目只是单纯的迁移代码，但是上面这些项目迁移出来后与原仓库还存在关联关系——即它们属于 wizdom-react 的submodule。<strong>可以简单理解为：wizdom-react是一个大仓库，我们在它的 src/plugins 目录下又 clone 了一个新仓库进来，只不过submodule这个clone方式有点不同，它会让主仓库和子仓库之间产生一定的联系。</strong></p>
<p>git submodule 相关文档：</p>
<p>wizdom-react README文档【重要】：</p>
<p><a href="http://192.168.101.70:8000/frontend/wizdom-react/-/blob/develop/README.md">http://192.168.101.70:8000/frontend/wizdom-react/-/blob/develop/README.md</a></p>
<p>git module 基本概念和用法：</p>
<p><a href="https://juejin.cn/post/6844903492750934029">https://juejin.cn/post/6844903492750934029</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/87053283">https://zhuanlan.zhihu.com/p/87053283</a></p>
<p>如果实在不想看文档，下面摘出非常重要的几点务必认真阅读（<strong>以wizsite为例</strong>）：</p>
<h2><a id="%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>目录结构</h2>
<pre><code class="language-plain_text">react
├── src
│   └── plugins                 # 子系统目录
│       └── wizsite             # 子系统
│           ├── src             # 源码
│           │   ├── images      # 图片
│           │   ├── pages       # 页面
│           │   ├── routes      # 路由
│           │   └── setting     # 配置
│           └── package.json
└── package.json
</code></pre>
<h2><a id="git%E6%93%8D%E4%BD%9C" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>git操作</h2>
<h3><a id="1%E3%80%81%E6%96%B0%E5%A2%9Esubmodule" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1、新增submodule</h3>
<p>如果wizdom-react中已经新增过submodule了直接略过此步骤.</p>
<blockquote>
<p>除了用下面的方式，也可以在根目录下直接一条命令搞定：git submodule add --force ssh://git@192.168.101.70:222/csgl/frontend/wizdom-react-plugins/wizsite.git src/plugins/wizsite</p>
</blockquote>
<pre><code class="language-shell"># 记住新增submodule是新增在plugins目录下，故要先cd到src/plugins这个目录里边
cd ./src/plugins
git submodule add ssh://git@192.168.101.70:222/csgl/frontend/wizdom-react-plugins/wizsite.git
</code></pre>
<p>执行完上述命令后，wizsite项目代码就会clone到plugins目录下，同时在wizdom-react的根目录下的 .gitmodules 文件中会追加几行记录，表示该submodule已经添加进来了。</p>
<p><img src="https://yuanchaowhut.oss-cn-hangzhou.aliyuncs.com/images/202207231303410.png" alt="image-20220723130259269" /></p>
<p>进入wizsite目录，会发现它默认是master分支。由于我们通常是在wizdom-react的develop分支开发，所以开发时请将 wizsite 切换到 develop 分支。</p>
<pre><code class="language-shell"># 由于当前是在src/plugins目录下，需要cd到wizsite里
cd wizdite
# 现在是master分支，需切换到develop分支
git checkout develop
</code></pre>
<h3><a id="2%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96submodule" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>2、初始化submodule</h3>
<p>由于目前新增submodule的工作是我来做的，我新增了submodule后，大家需要把代码拉下来。<strong>需要注意的是，与新增 submodule 不同，初始化 submodule 需要在 wizdom-react的根目录下进行。</strong></p>
<blockquote>
<p>新增的时候需要切换到 src/plugins 目录下，当然也有不切换直接在wizdom-react主目录下干的方式，相对而言本文档这种比较好理解一些。</p>
</blockquote>
<p>第一步：修改 .gitmodules 文件，屏蔽掉非本部门的submodule。</p>
<p><strong><font color="red">备注：这种方式是一次update所有submodule， 由于各个部门仓库权限问题，才需要这么做，但是后面有更好的方式，请继续往下阅读。</font></strong></p>
<p>因为其它部门的仓库，我们没有权限，如果不屏蔽掉，会导致整体代码都clone不下来。</p>
<p><img src="https://yuanchaowhut.oss-cn-hangzhou.aliyuncs.com/images/202207231331909.png" alt="image-20220723133125691" /></p>
<p>第二步：执行  <strong>git submodule init</strong>  初始化submodule。</p>
<hr />
<p><strong><font color="red">备注：init 和 update 可以放到一条命令里，请继续往下阅读。</font></strong></p>
<p><img src="https://yuanchaowhut.oss-cn-hangzhou.aliyuncs.com/images/202207231345057.png" alt="image-20220723134530408" /></p>
<p>第三步：执行  <strong>git submodule update</strong> 即可拉取所有submodule的代码。</p>
<p><strong><font color="red">备注：第三步：执行  git submodule update --init --remote ./src/plugins/xxx(submodule名称)，clone 指定的submodule代码到本地</font></strong></p>
<p><img src="https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/LAJdl62EgpGQlke1/img/d0c0bab9-15bd-447e-beb9-a19ca50cb3d2.png" alt="img" /></p>
<p><strong>第一次进入 submodule ，会看到 git(1bab43xx) ，貌似产生了一个新分支，但实际上没有。切换分支到develop后（git checkout develop ）后， 用 git branch -a 命令查看， 没有产生多余分支，因此大家不用理会。</strong></p>
<p><strong><img src="https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/LAJdl62EgpGQlke1/img/3cece30b-e98d-4be0-a749-fe13027bfea5.png" alt="img" /></strong></p>
<h3><a id="3%E3%80%81%E6%9B%B4%E6%96%B0submodule" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>3、更新submodule</h3>
<p>当我们修改了submodule（如：wizsite）里的代码后，需要提交代码，这个提交需要分2个步骤，第一步提交submodule的代码，第二步提交submodule版本信息。</p>
<pre><code class="language-shell"># 查看是否在submodule(如：wizsite)目录下，如果不是则需进入submodule 目录
cd ./src/plugins/wizsite

# 提交 submodule 代码，注意submodule是否处于develop分支，如果不是则切换到develop
git add
git commit
git push

# 返回wizdom-react 主目录
cd ../../../

# 提交 submodule 文件版本信息，所谓版本信息其实就 .gitmodules，src/plugins/wizsite 等
git add
git commit
git push
</code></pre>
<h3><a id="4%E3%80%81%E5%88%A0%E9%99%A4submodule" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>4、删除submodule</h3>
<p>暂时涉及不到，不过前面发的文档里有操作方法。</p>
<h2><a id="%E9%A1%B9%E7%9B%AE%E5%90%AF%E5%8A%A8%E6%88%96%E6%89%93%E5%8C%85" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>项目启动或打包</h2>
<h3><a id="%E8%BF%90%E8%A1%8C%E5%8E%9Fpages%E4%B8%8B%E7%9A%84%E4%BB%A3%E7%A0%81" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>运行原 pages 下的代码</h3>
<p>截止到目前，wizdom-react的本部门的项目，均已完成迁移，因此这个方式不再建议，后期 pages目录下的代码一删掉，这种方式就终结了。</p>
<p>1、修改App.js文件切换注释</p>
<p><img src="https://yuanchaowhut.oss-cn-hangzhou.aliyuncs.com/images/202207231359898.png" alt="image-20220723135906460" /></p>
<p>2、执行相关命令</p>
<pre><code class="language-shell">#启动命令
pnpm start xxx

#打包命令
pnpm run build xxx
</code></pre>
<h3><a id="%E8%BF%90%E8%A1%8Cplugins%E4%B8%8B-submodule%E4%BB%A3%E7%A0%81" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>运行 plugins 下submodule代码</h3>
<pre><code class="language-shell">#启动命令
pnpm start xxx -- --plugin

#打包命令
pnpm run build xxx -- --plugin
</code></pre>
<h1><a id="%E6%94%B6%E8%8E%B7%E4%B8%8E%E5%88%86%E4%BA%AB" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>收获与分享</h1>
<p>本次仓库迁移整改遇到了很多问题，在解决相关问题的过程中，也学习到了不少东西，这里简单的分享几个小技巧。</p>
<h2><a id="1%E3%80%81prettier%E6%89%B9%E9%87%8F%E6%A0%BC%E5%BC%8F%E5%8C%96" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1、prettier 批量格式化</h2>
<p>我们平时用的比较多的是在 webstore、visual studio 里设置启用 prettier，但是这种方式只能格式化某一个打开的文件，在迁移仓库这么繁杂的工作中，不可能挨个打开文件去格式化，所以使用 prettier 自身的命令去批量处理是一个不错的选择。</p>
<p>参考文档：<a href="https://prettier.io/docs/en/cli.html">https://prettier.io/docs/en/cli.html</a></p>
<p>相关命令：</p>
<pre><code class="language-shell">#check 是检查，write是执行格式化代码的操作.
prettier --check ./*.js

prettier --write ./*.js

prettier --check ./src/**/*.js

prettier --write ./src/**/*.js

prettier --config ./my/.prettierrc --write ./my/file.js
</code></pre>
<h2><a id="2%E3%80%81%E5%85%A8%E5%B1%80%E6%9B%BF%E6%8D%A2%E5%BC%95%E7%94%A8%E8%B7%AF%E5%BE%84" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>2、全局替换引用路径</h2>
<p>在整理wizdom-react中的项目时，由于代码路径变了，所以代码中类似 @/images/xxx/、@pages/xxx/ 这样的引用路径都需要修改，同样也不可能挨个搜索替换，可以使用 sed 命令处理。</p>
<pre><code class="language-shell"># 替换图片引用路径
sed -i &quot;s|@/images/wizsite|@/plugins/wizsite/src/images|g&quot; src/**/*.js src/**/*.scss

# 替换组件引用路径
sed -i &quot;s|@/pages/wizsite|@/plugins/wizsite/src/pages|g&quot; src/**/*.js
</code></pre>

                  </article>
                  <div class="comments-wrap">
                    <div class="share-comments">
                      

                      

                      
                    </div>
                  </div><!-- end comments wrap -->
              </div>
            </div><!-- end columns -->
      </div><!-- end container -->
    </section>



    <footer class="footer">
        <div class="content has-text-centered">
          <p>
              Copyright &copy; 2019
              Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
              Theme used <a target="_blank" href="https://bulma.io/">Bulma CSS</a>.
          </p>
        </div>
      </footer>



  













<script src="asset/prism.js"></script>



  
    




  </body>
</html>
